name: CI/CD Pipeline

# å…¨å±€ç¯å¢ƒå˜é‡ - ä½¿ç”¨ Variablesï¼ˆéæ•æ„Ÿé…ç½®ï¼ŒSecrets åœ¨å„å­ workflow ä¸­å®šä¹‰ï¼‰
env:
  # åŸºç¡€æ„å»ºé…ç½®
  BINARY_NAME: ${{ vars.BINARY_NAME || github.event.repository.name }}
  BINARY_SOURCE_DIR: ${{ vars.BINARY_SOURCE_DIR || 'deployments' }}
  # Go è¯­è¨€ç¯å¢ƒé…ç½®
  GO_VERSION: ${{ vars.GO_VERSION || '1.25.1' }}
  GOTESTSUM_VERSION: ${{ vars.GOTESTSUM_VERSION || 'v1.13.0' }}
  GOPROXY: ${{ vars.GOPROXY || 'https://goproxy.cn,direct' }}
  GOPRIVATE: ${{ vars.GOPRIVATE || 'github.com/kamalyes' }}
  # æ„å»ºä¼˜åŒ–é…ç½®
  UPX_COMPRESS: ${{ vars.UPX_COMPRESS || 'false' }}

permissions:
  contents: read
  packages: write

on:
  push:
    branches:
      - develop
    paths-ignore:
      - '**/*.md'
  workflow_dispatch:
    inputs:
      environment:
        description: 'éƒ¨ç½²ç¯å¢ƒ'
        required: true
        type: choice
        options:
          - dev
          - test
          - uat
          - prod
        default: dev
      code-quality:
        description: 'æ˜¯å¦è¿›è¡Œä»£ç è´¨é‡æ£€æŸ¥'
        required: false
        type: boolean
        default: true

jobs:
  # å‡†å¤‡ç¯å¢ƒå’Œä¾èµ–
  setup:
    name: Setup Environment
    runs-on: ubuntu-latest
    environment: ${{ inputs.environment || 'dev' }}
    outputs:
      binary-name: ${{ steps.setup-vars.outputs.binary-name }}
      binary-source-dir: ${{ steps.setup-vars.outputs.binary-source-dir }}
      binary-output: ${{ steps.setup-vars.outputs.binary-output }}
      go-version: ${{ steps.setup-vars.outputs.go-version }}
      gotestsum-version: ${{ steps.setup-vars.outputs.gotestsum-version }}
      version: ${{ steps.setup-vars.outputs.version }}
      build-time: ${{ steps.setup-vars.outputs.build-time }}
      git-commit: ${{ steps.setup-vars.outputs.git-commit }}
      upx-compress: ${{ steps.setup-vars.outputs.upx-compress }}
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v6

      - name: ğŸ› ï¸ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ env.GO_VERSION }}
          cache: true

      # - name: ğŸ”‘ Configure Git for Private Modules (PAT)
      #   run: |
      #     git config --global url."https://${{ secrets.GO_MODULE_PAT }}@github.com".insteadOf "https://github.com"

      - name: ğŸ”‘ Setup SSH Key for Private Modules
        uses: webfactory/ssh-agent@v0.9.0
        with:
          ssh-private-key: ${{ secrets.GIT_SSH_PRIVATE_KEY }}

      - name: ğŸ”§ Configure Git to use SSH for Private Repos
        run: |
          git config --global url."git@github.com:".insteadOf "https://github.com/"

      - name:  Download Dependencies
        run: |
          export GOPROXY="${{ env.GOPROXY }}"
          export GOPRIVATE="${{ env.GOPRIVATE }}"
          go mod download

      - name: âš™ï¸ Setup Variables
        id: setup-vars
        run: |
          # è·å–çŸ­ commit hash
          SHORT_COMMIT=$(git rev-parse --short HEAD)
          
          # è·å–å½“å‰åˆ†æ”¯
          BRANCH="${{ github.ref_name }}"
          
          # ä»ç¯å¢ƒå˜é‡æˆ–å…¨å±€å˜é‡è¯»å–é…ç½®ï¼ˆä¼˜å…ˆä½¿ç”¨ç¯å¢ƒçº§åˆ«çš„é…ç½®ï¼‰
          BINARY_NAME="${{ vars.BINARY_NAME || env.BINARY_NAME }}"
          BINARY_SOURCE_DIR="${{ vars.BINARY_SOURCE_DIR || env.BINARY_SOURCE_DIR }}"
          GO_VERSION="${{ vars.GO_VERSION || env.GO_VERSION }}"
          GOTESTSUM_VERSION="${{ vars.GOTESTSUM_VERSION || env.GOTESTSUM_VERSION }}"
          UPX_COMPRESS="${{ vars.UPX_COMPRESS || env.UPX_COMPRESS }}"
          
          # åŸºæœ¬æ„å»ºä¿¡æ¯
          echo "binary-name=${BINARY_NAME}" >> $GITHUB_OUTPUT
          echo "binary-source-dir=${BINARY_SOURCE_DIR}" >> $GITHUB_OUTPUT
          echo "binary-output=${BINARY_SOURCE_DIR}/${BINARY_NAME}" >> $GITHUB_OUTPUT
          echo "upx-compress=${UPX_COMPRESS}" >> $GITHUB_OUTPUT

          # ç‰ˆæœ¬å’Œæ„å»ºä¿¡æ¯
          echo "go-version=${GO_VERSION}" >> $GITHUB_OUTPUT
          echo "gotestsum-version=${GOTESTSUM_VERSION}" >> $GITHUB_OUTPUT
          
          # æ„å»ºä¿¡æ¯ï¼ˆåŠ¨æ€ç”Ÿæˆï¼‰
          echo "version=${BRANCH}-${SHORT_COMMIT}" >> $GITHUB_OUTPUT
          echo "build-time=$(date -u '+%Y-%m-%d_%H:%M:%S')" >> $GITHUB_OUTPUT
          echo "git-commit=${SHORT_COMMIT}" >> $GITHUB_OUTPUT

          echo "code-quality=${{ inputs.code-quality }}" >> $GITHUB_OUTPUT

      - name: ğŸ“‹ Print All Outputs
        run: |
          echo "========================================"
          echo "        Setup Job Outputs Summary       "
          echo "========================================"
          echo ""
          echo "ğŸ“¦ Binary Information:"
          echo "  - binary-name: ${{ steps.setup-vars.outputs.binary-name }}"
          echo "  - binary-source-dir: ${{ steps.setup-vars.outputs.binary-source-dir }}"
          echo "  - binary-output: ${{ steps.setup-vars.outputs.binary-output }}"
          echo "  - upx-compress: ${{ steps.setup-vars.outputs.upx-compress }}"
          echo ""
          echo "ğŸ”§ Go Environment:"
          echo "  - go-version: ${{ steps.setup-vars.outputs.go-version }}"
          echo "  - gotestsum-version: ${{ steps.setup-vars.outputs.gotestsum-version }}"
          echo ""
          echo "ğŸ·ï¸  Build Information:"
          echo "  - version: ${{ steps.setup-vars.outputs.version }}"
          echo "  - build-time: ${{ steps.setup-vars.outputs.build-time }}"
          echo "  - git-commit: ${{ steps.setup-vars.outputs.git-commit }}"
          echo ""
          echo "ğŸŒ Service Ports:"
          echo "  - http-port: ${{ steps.setup-vars.outputs.http-port }}"
          echo "  - rpc-port: ${{ steps.setup-vars.outputs.rpc-port }}"
          echo "  - ws-port: ${{ steps.setup-vars.outputs.ws-port }}"
          echo ""

          echo "ğŸ¯ Deployment Strategy:"
          echo "  - code-quality: ${{ steps.setup-vars.outputs.code-quality }}"
          echo ""
          echo "========================================"

  # ç¬¬ä¸€æ­¥ï¼šä»£ç è´¨é‡æ£€æŸ¥
  code-quality:
    name: Code Quality Check
    needs: setup
    uses: ./.github/workflows/code-quality.yml
    with:
      go-version: ${{ needs.setup.outputs.go-version }}
      gotestsum-version: ${{ needs.setup.outputs.gotestsum-version }}
    secrets: inherit

  # ç¬¬äºŒæ­¥ï¼šæ„å»ºäºŒè¿›åˆ¶æ–‡ä»¶ï¼ˆä¸ä»£ç æ£€æŸ¥å¹¶è¡Œï¼‰
  build-binary:
    name: Build Binary
    needs: setup
    uses: ./.github/workflows/build-binary.yml
    with:
      go-version: ${{ needs.setup.outputs.go-version }}
      binary-name: ${{ needs.setup.outputs.binary-name }}
      binary-source-dir: ${{ needs.setup.outputs.binary-source-dir }}
      binary-output: ${{ needs.setup.outputs.binary-output }}
      version: ${{ needs.setup.outputs.version }}
      build-time: ${{ needs.setup.outputs.build-time }}
      git-commit: ${{ needs.setup.outputs.git-commit }}
      upx-compress: ${{ needs.setup.outputs.upx-compress }}
    secrets: inherit

  # ç¬¬ä¸‰æ­¥ï¼šæ„å»ºæµ‹è¯•æœåŠ¡å™¨ï¼ˆä¸ä¸»ç¨‹åºå¹¶è¡Œï¼‰
  build-test-server:
    name: Build Test Server
    needs: setup
    uses: ./.github/workflows/build-binary.yml
    with:
      go-version: ${{ needs.setup.outputs.go-version }}
      binary-name: test-server
      binary-source-dir: ${{ needs.setup.outputs.binary-source-dir }}
      binary-output: ${{ needs.setup.outputs.binary-source-dir }}/test-server
      version: ${{ needs.setup.outputs.version }}
      build-time: ${{ needs.setup.outputs.build-time }}
      git-commit: ${{ needs.setup.outputs.git-commit }}
      upx-compress: ${{ needs.setup.outputs.upx-compress }}
      source-file: testserver/test_server.go
    secrets: inherit