name: Code Quality Check

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version'
        required: true
        type: string
      gotestsum-version:
        description: 'gotestsum version'
        required: true
        type: string

jobs:
  code-quality:
    name: ğŸ› ï¸ Code Quality Check
    runs-on: ubuntu-latest
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v6

      - name: ğŸ› ï¸ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: ğŸ§¹ Format Check
        run: |
          if [ "$(gofmt -s -l . | wc -l)" -gt 0 ]; then
            echo "ä»¥ä¸‹æ–‡ä»¶éœ€è¦æ ¼å¼åŒ–:"
            gofmt -s -l .
            exit 1
          fi

      - name: ğŸ” Vet Check
        run: go vet ./...

      - name: ğŸ“¦ Install gotestsum
        run: go install gotest.tools/gotestsum@${{ inputs.gotestsum-version }}

      - name: ğŸ§ª Test with Coverage
        run: gotestsum -f testname -- ./... -race -count=1 -coverprofile=coverage -covermode=atomic -shuffle=on
        continue-on-error: true

      - name: ğŸ“Š Generate Coverage Report
        if: always()
        run: |
          if [ -f coverage ]; then
            go tool cover -html=coverage -o coverage.html
          fi

      - name: ğŸ“¤ Upload Coverage
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: coverage-report
          path: |
            coverage
            coverage.html
          retention-days: 7
