name: Build Binary

on:
  workflow_call:
    inputs:
      go-version:
        description: 'Go version'
        required: true
        type: string
      binary-name:
        description: 'Binary name'
        required: true
        type: string
      binary-source-dir:
        description: 'Binary source directory'
        required: true
        type: string
      binary-output:
        description: 'Binary output path'
        required: true
        type: string
      version:
        description: 'Build version'
        required: true
        type: string
      build-time:
        description: 'Build time'
        required: true
        type: string
      git-commit:
        description: 'Git commit hash'
        required: true
        type: string
      upx-compress:
        description: 'Enable UPX compression'
        required: false
        type: string
        default: 'false'
      source-file:
        description: 'Source file to build'
        required: false
        type: string
        default: 'main.go'

jobs:
  build-binary:
    name: Build ${{ matrix.os }}/${{ matrix.arch }}
    runs-on: ubuntu-latest
    strategy:
      matrix:
        include:
          - os: linux
            arch: amd64
          - os: linux
            arch: arm64
          - os: windows
            arch: amd64
          - os: windows
            arch: arm64
          - os: darwin
            arch: amd64
          - os: darwin
            arch: arm64
    steps:
      - name: â¬‡ï¸ Checkout Repository
        uses: actions/checkout@v6

      - name: ğŸ› ï¸ Set up Go
        uses: actions/setup-go@v5
        with:
          go-version: ${{ inputs.go-version }}
          cache: true

      - name: ğŸ”¨ Build Binary
        run: |
          chmod +x scripts/build-linux.sh
          
          # è®¾ç½®äºŒè¿›åˆ¶æ–‡ä»¶æ‰©å±•å
          BINARY_EXT=""
          if [ "${{ matrix.os }}" = "windows" ]; then
            BINARY_EXT=".exe"
          fi
          
          ./scripts/build-linux.sh \
            --version "${{ inputs.version }}" \
            --build-time "${{ inputs.build-time }}" \
            --git-commit "${{ inputs.git-commit }}" \
            --binary-name "${{ inputs.binary-name }}" \
            --output-dir "${{ inputs.binary-source-dir }}" \
            --os "${{ matrix.os }}" \
            --arch "${{ matrix.arch }}" \
            --upx-compress "${{ inputs.upx-compress }}" \
            --source-file "${{ inputs.source-file }}"
          
          echo "âœ… æ„å»ºå®Œæˆ: ${{ inputs.binary-name }} for ${{ matrix.os }}/${{ matrix.arch }}"
          ls -lh "${{ inputs.binary-source-dir }}"

      - name: ğŸ“¤ Upload Binary
        uses: actions/upload-artifact@v4
        with:
          name: ${{ inputs.binary-name }}-${{ matrix.os }}-${{ matrix.arch }}
          path: ${{ inputs.binary-source-dir }}/${{ inputs.binary-name }}${{ matrix.os == 'windows' && '.exe' || '' }}
          retention-days: 7
